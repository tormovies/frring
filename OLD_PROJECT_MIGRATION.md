# Миграция: старый FreeRingtones → новый движок (Laravel)

Документ фиксирует **всё из текущего проекта**, чтобы при переносе на NewRingtone ничего не потерять. Аудиофайлы не трогаем и никуда не заливаем — важно сохранить **где они лежат и как называются**.

---

## 1. Аудиофайлы (не в папке проекта, на сервере)

- **Базовый URL (прод):** `https://cp1.freeringtones.ru/`  
  В коде: `$config['contentdomain']` в `config.php` (строка 15).

- **URL прослушивания/скачивания MP3:**  
  `{contentdomain}mp3/{значение поля ringtone.file}`  
  Примеры из БД:
  - `alias.mp3` → `https://cp1.freeringtones.ru/mp3/alias.mp3`
  - `c399/bon-jovi-god-bless-this-mess.mp3` → `https://cp1.freeringtones.ru/mp3/c399/bon-jovi-god-bless-this-mess.mp3`  
  То есть на сервере возможны подпапки внутри `mp3/` (например `c399/`, `1d7d/`, `73c8/`).

- **M4R (iPhone):**  
  Если `ringtone.uniq_text = 1`, то файл: то же имя, но расширение `.m4r`.  
  URL: `{contentdomain}m4r/{alias}.m4r` (в коде: `m4rfile = file с заменой .mp3 → .m4r`).  
  Шаблон: `template/play-new.tpl`, переменная `$config.contentdomain`, пути `mp3/` и `m4r/`.

- **Итог:** где физически лежат файлы на сервере (диск, домен cp1) — нужно зафиксировать у себя. В проекте важно: **поле `ringtone.file`** (и при необходимости подпапка) — это полный относительный путь от `mp3/` (или от корня раздачи). Не терять соответствие: запись в БД ↔ путь/URL файла.

---

## 2. Превью (картинки)

- В БД: `ringtone.image` — имя файла, например `default.png` или `40238b0c63-alias.jpg`.
- В коде проверяется наличие: `thumbs200/{image}` или иначе `thumbs/{image}` (см. `play-new.php`, строки 12–15).
- URL на сайте: `{httpDomain}thumbs/` или `{httpDomain}thumbs200/`.  
  В бэкапе есть папки: `public_html/thumbs/`, `public_html/content/` — часть превью может быть в проекте, часть на сервере. При переносе дизайна/данных — сохранить логику имён и путей.

---

## 3. База данных (структура, чтобы ничего не потерять)

### 3.1 Таблица `ringtone`

| Поле           | Тип/комментарий |
|----------------|------------------|
| id             | PK, auto_increment |
| name           | Название рингтона |
| description    | Описание (HTML) |
| hints          | Текст/подсказка |
| plays          | Прослушивания |
| votes, votes_count, rating | Рейтинг |
| datestamp      | Unix time |
| author         | user_id |
| **file**       | **Имя/путь файла (относительно mp3/)** — критично для аудио |
| type           | tinyint |
| screens        | text |
| **image**      | **Имя превью** |
| **alias**      | **URL slug (уникальный)** |
| cat            | Основная категория (cat_id) |
| size           | Размер файла |
| downloads      | Скачивания |
| height         | Битрейт |
| width          | Длительность (например "0:32") |
| original_name  | Исполнитель/название для отображения |
| uniq_text      | 1 = есть m4r |

### 3.2 Таблица `cats`

- cat_id, cat_name, cat_alias, cat_description, rating, on_main, parent_cat.  
- Категории иерархические (parent_cat). Используются в меню и ЧПУ.

### 3.3 Связь рингтон ↔ категории (многие ко многим): `ringtone_gat`

- id — id рингтона, catid — id категории.  
- Один рингтон может быть в нескольких категориях. При импорте в новый движок эту связь нужно сохранить.

### 3.4 Таблица `seo`

- seo_id, seo_title, seo_h1, seo_description, seo_text, seo_keywords, **seo_type**, **seo_item**.  
- **seo_type:** `IND` (главная), `CAT` (категория), `ITE` (рингтон), `PAG` (страница).  
- **seo_item:** id сущности (0 = дефолт для типа).  
- Всё это нужно перенести в новую схему (или в отдельную таблицу/поля), чтобы не потерять SEO.

### 3.5 Остальные таблицы (из дампа)

- 301redirect, pages, settings, users, pay_order, rating, desc_stats, earn_stats, textru_cecking, temp_ringtone, temp_ringtone_gat, temp_seo и т.д. — при импорте решить, какие сущности нужны новому движку; данные лучше сохранить (хотя бы экспортом), чтобы ничего не потерять.

---

## 4. SEO: где лежит и как не потерять

### 4.1 В базе

- Таблица **seo** (см. выше). Подстановки в текстах: `%year%`, `%site_name%`, `%page_name%` (в `core.php`).

### 4.2 В PHP

- **core.php** (примерно строки 91–255): выборка SEO по типу страницы (IND/CAT/ITE/PAG), fallback на seo_item=0, подстановка %year%, %site_name%, %page_name%. Жёстко прописанные заголовки/описания для главной по порядку (date/rating/plays) и пагинации.  
- При переносе: либо воспроизвести логику в Laravel, либо один раз выгрузить сгенерированные title/description/keywords/h1 в CSV или в новую БД.

### 4.3 В шаблонах

- **template/header.tpl** (и скомпилированные в smarty): вывод `seo_title`, `seo_description`, `seo_keywords` в `<title>` и meta.  
- В Blade/новом движке нужно выводить те же поля (или их маппинг из новой схемы).

### 4.4 В админке

- **cms/ajax.php**, **cms/seo.php**: редактирование SEO для категорий, рингтонов, страниц (ITE, CAT, PAG). Форматы полей: seo_title, seo_h1, seo_keywords, seo_description, seo_text.  
- При миграции: либо импорт в новую админку, либо скрипт переноса из таблицы `seo` в структуру нового движка.

---

## 5. ЧПУ и роутинг (для натягивания дизайна/логики)

- В **.htaccess**: category, play, page, user, register, sitemap, author.  
- Примеры:  
  `play/{alias}.html`,  
  `category/{alias}-{rowstart}-{order}.html`,  
  `page/{alias}.html`.  
- В новом движке (Laravel) нужно будет настроить маршруты и по возможности те же URL, чтобы не потерять ссылки и SEO.

---

## 6. Конфиг и домены

- **config.php:** domaisd, httpDomain, contentdomain (cp1), настройки БД, textru, yandex, cost/refearn и т.д.  
- Для миграции важно: contentdomain (где аудио), список доменов и любые кастомные настройки — перенести в .env или конфиги Laravel, ничего не выкидывать.

---

## 7. Что сделать перед/во время миграции

1. **Аудио:** записать, где на проде физически лежат каталоги для `cp1.freeringtones.ru` (mp3/, m4r/ и подпапки). Не перемещать файлы — только сохранить соответствие `ringtone.file` ↔ реальный путь/URL.
2. **БД:** экспорт таблиц ringtone, cats, ringtone_gat, seo, pages, settings, users (и при необходимости остальных). Сохранить дамп как резервную копию.
3. **SEO:** выгрузить таблицу `seo` и при необходимости сгенерированные из core.php варианты для главной/категорий (если решите не портировать логику один в один).
4. **Дизайн/шаблоны:** папки template/, template3/, css/, изображения — сохранить для последующего «натягивания» на новый движок; в шаблонах уже учтены meta и частично SEO.

После клонирования Laravel-проекта в `NewRingtone` можно будет сопоставить эту схему с моделями/миграциями Laravel и написать скрипт импорта (данные + SEO + пути к файлам без переноса самих аудио).
