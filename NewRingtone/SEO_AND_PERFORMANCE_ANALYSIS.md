# Анализ SEO и производительности проекта

Дата: 2026-01-29

---

## Часть 1: SEO-оптимизация

### Что уже сделано хорошо

| Элемент | Статус | Где |
|--------|--------|-----|
| **Title** | ✅ | `layouts/app.blade.php` — `@yield('title')`, страницы задают свой title |
| **Meta description** | ✅ | То же — `@yield('description')` |
| **Уникальные title/description** | ✅ | Главная, материал, категория, тег, тип, автор, статья, страница — свои шаблоны с `meta_replace()` |
| **Один H1 на страницу** | ✅ | В шаблонах используется `h1` (page-title или article-title) |
| **Язык страницы** | ✅ | `<html lang="ru">` |
| **Viewport** | ✅ | `<meta name="viewport" content="width=device-width, initial-scale=1.0">` |
| **Favicon** | ✅ | SVG + alternate .ico |
| **Плейсхолдеры для года/страницы** | ✅ | `meta_replace()` — `%year%`, `%page%`, для материала — `%author%`, `%bitrate%`, `%duration%`, `%category%` |
| **robots.txt** | ✅ | `public/robots.txt` — разрешён полный обход |

### Чего не хватает (рекомендации)

| Проблема | Рекомендация |
|----------|--------------|
| **Нет Open Graph (og:)** | Соцсети показывают ссылку без картинки и нормального заголовка. Добавить в `layouts/app.blade.php` в `<head>`: `og:title`, `og:description`, `og:url`, `og:image`, `og:type`, `og:locale` |
| **Нет Twitter Card** | Добавить `twitter:card`, `twitter:title`, `twitter:description`, `twitter:image` (можно дублировать из OG) |
| **Нет canonical URL** | Для пагинации и дублей добавить `<link rel="canonical" href="{{ url()->current() }}">` (или явный canonical для страниц с параметрами) |
| **Нет sitemap.xml** | Поисковикам проще индексировать сайт. Реализовать маршрут/контроллер для sitemap (материалы, категории, типы, теги, статьи, страницы) или пакет `spatie/laravel-sitemap` |
| **Пустое description на части страниц** | Если `@yield('description')` пустой — в выдаче может быть обрезок текста. Убедиться, что у всех публичных страниц задан осмысленный description |
| **Нет структурированных данных (JSON-LD)** | Для статей/аудио можно добавить Schema.org (Article, MusicRecording и т.п.) — улучшает сниппеты в поиске |

### Итог по SEO

- Базовый SEO в порядке: уникальные title/description, H1, русский язык, robots.txt.
- Для соцсетей и лучшей индексации стоит добавить: **OG/Twitter**, **canonical**, **sitemap.xml**, при желании — **JSON-LD**.

---

## Часть 2: Скорость загрузки и работы

### Уже сделано

| Элемент | Статус |
|--------|--------|
| **Кеш статики в .htaccess** | ✅ `mod_expires` — картинки 1 год, CSS/JS 1 месяц |
| **Gzip** | ✅ `mod_deflate` — сжатие HTML, CSS, JS, JSON |
| **Cache-Control для статики** | ✅ Заголовки для jpg/png/gif/webp/css/js |
| **Eager loading в контроллерах** | ✅ MaterialController (show, popular, best), TypeController, CategoryController, TagController, AuthorController, ArticleController — везде `->with([...])` для связей |
| **Кеш статистики в Dashboard** | ✅ `Cache::remember("user_stats_{$user->id}", 300, ...)` и один запрос с `groupBy('moderation_status')` |
| **Уникальные индексы** | ✅ В миграциях: `slug` unique у materials, типы/категории и т.д. |

### Проблемы и решения

#### 1. N+1 на главной странице (MainController)

**Проблема:**

- `$popular` и `$best` загружаются без `with(['type', 'authors'])`. В шаблоне для каждого материала вызываются `$item->type`, `$item->authors->first()` — по 2 дополнительных запроса на материал: 6+6 = 12 материалов → **до 24 лишних запросов**.
- Материалы в блоках по типам (`$type->materials`) подгружаются через `setRelation`, но у каждого материала в шаблоне используются `$material->authors` и `$material->categories` без eager load — ещё **десятки запросов** (порядка 2 запроса на материал × число материалов в блоках типов).

**Решение:**  
В `MainController::index()`:

- Для «Популярные» и «Лучшие» добавить `->with(['type', 'authors'])`.
- Для материалов внутри типов загружать материалы с `->with(['authors', 'categories'])` (или включать type, если нужен в шаблоне).

#### 2. N+1 на странице материала (MaterialController::show)

**Проблема:**  
`$related` загружается как `Material::active()->where(...)->limit(6)->get()` без `with()`. В шаблоне для каждого из 6 материалов вызываются `$rel->authors`, `$rel->type` → **до 12 лишних запросов**.

**Решение:**  
Загружать related с eager load: `->with(['type', 'authors'])`.

#### 3. Индекс по status для materials

**Проблема:**  
Почти везде выборка материалов идёт с `->where('status', true)` или `->active()`, но по таблице `materials` нет индекса по `status` (или составного с часто используемыми полями).

**Решение:**  
Добавить миграцию с индексом по `status` или составным индексом, например `(status, type_id)` / `(status, created_at)` в зависимости от частых запросов.

#### 4. Скрипты и стили

| Элемент | Текущее состояние | Рекомендация |
|--------|--------------------|--------------|
| **styles.css** | Подключается через `asset('css/styles.css')` в head | Ок для одного основного файла; на проде убедиться, что используется сжатая версия (Vite build или минификация) |
| **script.js** | В конце body без `defer` | Добавить `defer`: `<script src="..." defer></script>` — не блокирует разбор страницы |
| **Яндекс.Метрика** | Подключается асинхронно (`async=1`) | ✅ Нормально |

#### 5. Изображения

- В списках (статьи, автор и т.д.) у `<img>` нет `loading="lazy"` — браузер не откладывает загрузку картинок ниже первого экрана.
- **Рекомендация:** для изображений в списках и блоках «ниже сгиба» добавить `loading="lazy"`.

#### 6. Кеширование Laravel на продакшене

- В проде должны быть включены: `config:cache`, `route:cache`, `view:cache` (или `php artisan optimize`), иначе каждый запрос разбирает конфиги/маршруты/шаблоны заново.
- Уже отмечено в `PERFORMANCE_ANALYSIS.md` — важно соблюдать при деплое.

#### 7. Размер и количество запросов

- Главная страница без исправления N+1 может выполнять **50–100+ запросов** к БД только из-за ленивой загрузки связей.
- После добавления eager load в MainController и MaterialController число запросов снизится до порядка **10–20** на главной и **5–10** на странице материала.

---

## Краткий чек-лист действий

### SEO

1. Добавить в layout Open Graph и Twitter Card (хотя бы title, description, url, image).
2. Добавить canonical URL (например, текущий URL без лишних параметров).
3. Реализовать sitemap.xml (ручной маршрут или пакет).
4. При желании — JSON-LD для статей/аудио.

### Производительность

1. **MainController:** загружать `popular` и `best` с `->with(['type', 'authors'])`, материалы по типам — с `->with(['authors', 'categories'])`.
2. **MaterialController::show:** загружать `$related` с `->with(['type', 'authors'])`.
3. Добавить индекс по `status` (или составной) в таблице `materials`.
4. Подключить `script.js` с атрибутом `defer`.
5. Для изображений в списках добавить `loading="lazy"`.
6. На продакшене использовать `config:cache`, `route:cache`, `view:cache` и минифицированные ассеты (Vite build).

После этих правок ожидаемо: меньше запросов к БД, быстрее главная и страница материала, лучше отображение в соцсетях и удобнее индексация для поисковиков.
